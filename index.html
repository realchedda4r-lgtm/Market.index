<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Food Bank">
    <meta name="theme-color" content="#1a1a1a">
    <link rel="apple-touch-icon" href="https://via.placeholder.com/180x180.png?text=Food+Bank">
    <link rel="manifest" href="/manifest.json">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <title>Food Bank Inventory Tracker</title>
    <style>
        :root {
            --bg-color: #1a1a1a;
            --text-color: #e0e0e0;
            --card-bg: #2c2c2c;
            --card-shadow: 0 2px 5px rgba(0,0,0,0.3);
            --btn-shadow: 0 2px 5px rgba(0,0,0,0.4);
            --table-border: #444;
            --table-hover: #333;
            --th-bg: #0055a4;
            --th-color: #e0e0e0;
            --low-stock-bg: #5c2a2a;
            --almost-low-bg: #5c4b2a;
            --good-stock-bg: #2a5c3a;
            --out-of-stock-bg: #3a3a3a;
            --out-of-stock-text: #999;
            --alert-bg: #8b0000;
            --alert-text: #e0e0e0;
            --expired-bg: #4a0000;
            --near-expired-bg: #5c4b00;
            --scanner-overlay: rgba(0, 255, 0, 0.3);
        }
        body {
            font-family: -apple-system, Arial, sans-serif;
            margin: 0;
            padding: 15px;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-size: 16px;
            touch-action: manipulation;
            -webkit-user-select: none;
            user-select: none;
            overscroll-behavior: none;
        }
        h1, h2 {
            text-align: center;
            color: var(--text-color);
            font-size: 1.5em;
            margin: 10px 0;
        }
        .form-container, .filter-container, .alert-container, .history-container, .overview-container, .chart-container {
            margin-bottom: 15px;
            padding: 15px;
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .overview-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around;
            text-align: center;
        }
        .overview-container div {
            flex: 1;
            min-width: 80px;
            margin: 5px;
            padding: 10px;
            background: var(--card-bg);
            border-radius: 8px;
            font-size: 14px;
        }
        .overview-container div span {
            font-weight: bold;
            color: var(--text-color);
        }
        input, select {
            width: calc(100% - 20px);
            padding: 12px;
            margin: 6px 0;
            border: 1px solid var(--table-border);
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
            background: var(--card-bg);
            color: var(--text-color);
        }
        input::placeholder, select::placeholder {
            color: var(--out-of-stock-text);
        }
        input[list] + datalist {
            background: var(--card-bg);
            color: var(--text-color);
        }
        button {
            width: calc(100% - 20px);
            padding: 14px;
            margin: 6px 0;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            color: white;
            cursor: pointer;
            background: linear-gradient(145deg, #28a745, #218838);
            box-shadow: var(--btn-shadow);
            transition: transform 0.2s, box-shadow 0.2s;
            -webkit-tap-highlight-color: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        button:hover, button:active {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            background: linear-gradient(145deg, #218838, #1e7e34);
        }
        button:active {
            transform: translateY(0);
        }
        .delete-btn {
            background: linear-gradient(145deg, #dc3545, #c82333);
        }
        .delete-btn:hover, .delete-btn:active {
            background: linear-gradient(145deg, #c82333, #b21f2d);
        }
        .out-btn {
            background: linear-gradient(145deg, #ffc107, #e0a800);
            color: black;
        }
        .out-btn:hover, .out-btn:active {
            background: linear-gradient(145deg, #e0a800, #d39e00);
        }
        .export-btn {
            background: linear-gradient(145deg, #17a2b8, #138496);
        }
        .export-btn:hover, .export-btn:active {
            background: linear-gradient(145deg, #138496, #117a8b);
        }
        .clear-btn {
            background: linear-gradient(145deg, #6c757d, #5a6268);
            width: auto;
            padding: 10px 20px;
            margin: 10px auto;
            display: block;
        }
        .clear-btn:hover, .clear-btn:active {
            background: linear-gradient(145deg, #5a6268, #545b62);
        }
        .scan-btn {
            background: linear-gradient(145deg, #6f42c1, #563d7c);
            width: auto;
            padding: 10px 20px;
        }
        .scan-btn:hover, .scan-btn:active {
            background: linear-gradient(145deg, #563d7c, #4c3680);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--card-bg);
            box-shadow: var(--card-shadow);
            font-size: 14px;
            position: relative;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--table-border);
        }
        th {
            background-color: var(--th-bg);
            color: var(--th-color);
            position: sticky;
            top: 0;
            z-index: 1;
        }
        tr {
            transition: transform 0.3s ease, opacity 0.5s ease;
        }
        tr:hover {
            background-color: var(--table-hover);
        }
        .low-stock {
            background-color: var(--low-stock-bg);
            font-weight: bold;
        }
        .almost-low {
            background-color: var(--almost-low-bg);
            font-weight: bold;
        }
        .good-stock {
            background-color: var(--good-stock-bg);
            font-weight: bold;
        }
        .out-of-stock {
            background-color: var(--out-of-stock-bg);
            font-weight: bold;
            color: var(--out-of-stock-text);
        }
        .expired {
            background-color: var(--expired-bg);
            font-weight: bold;
        }
        .near-expired {
            background-color: var(--near-expired-bg);
            font-weight: bold;
        }
        .alert-container {
            background-color: var(--alert-bg);
            color: var(--alert-text);
            border-radius: 8px;
            padding: 12px;
            display: none;
            animation: fadeIn 0.5s ease-in;
        }
        .alert-container.show {
            display: block;
        }
        .history-container {
            max-height: 250px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        .swipe-action {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            color: white;
            z-index: -1;
        }
        .swipe-delete {
            background: #dc3545;
            right: 0;
        }
        .swipe-update {
            background: #17a2b8;
            left: 0;
        }
        #scanner-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        #scanner-video {
            width: 90%;
            max-width: 640px;
            height: auto;
            max-height: 70%;
            object-fit: cover;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        #scanner-overlay {
            position: absolute;
            border: 2px solid var(--scanner-overlay);
            pointer-events: none;
            display: none;
        }
        #scanner-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 18px;
            display: none;
        }
        #scanner-controls {
            text-align: center;
            padding: 10px;
            width: 90%;
            max-width: 640px;
        }
        #scanner-controls button {
            width: auto;
            padding: 10px 20px;
        }
        .fifo-note {
            font-size: 12px;
            color: #bbb;
            text-align: center;
            margin: 10px 0;
        }
        .chart-container {
            max-width: 300px;
            margin: 0 auto;
        }
        @media (max-width: 600px) {
            body {
                padding: 10px;
            }
            table, thead, tbody, th, td, tr {
                display: block;
            }
            thead tr {
                display: none;
            }
            tr {
                margin-bottom: 12px;
                border-bottom: 2px solid var(--table-border);
                position: relative;
                overflow: hidden;
            }
            td {
                display: flex;
                justify-content: space-between;
                padding: 10px;
                position: relative;
                border: none;
            }
            td:before {
                content: attr(data-label);
                font-weight: bold;
                width: 40%;
            }
            td:last-child {
                justify-content: center;
            }
            td:last-child button {
                width: auto;
                padding: 10px 20px;
                margin: 0 8px;
            }
            button, input, select {
                font-size: 18px;
                padding: 14px;
            }
            .chart-container {
                max-width: 100%;
            }
            #scanner-video {
                width: 100%;
                max-height: 60%;
            }
        }
    </style>
</head>
<body>
    <h1>Food Bank Inventory Tracker</h1>
    <div class="overview-container">
        <div>Total Items: <span id="totalItems">0</span></div>
        <div>In Stock: <span id="inStock">0</span></div>
        <div>Out of Stock: <span id="outOfStock">0</span></div>
        <div>Low Stock: <span id="lowStock">0</span></div>
    </div>
    <div class="alert-container" id="smartAlert">
        <p id="smartMessage"></p>
    </div>
    <div class="form-container">
        <h2>Add/Update</h2>
        <input type="text" id="itemName" placeholder="Item Name" list="itemSuggestions" required>
        <datalist id="itemSuggestions"></datalist>
        <button class="scan-btn" onclick="startScanner()"><i class="fas fa-barcode"></i> Scan Barcode</button>
        <input type="number" id="quantity" placeholder="Quantity" required min="0">
        <select id="unit">
            <option value="">No Unit</option>
            <option value="Pounds">Pounds</option>
            <option value="Case">Case</option>
            <option value="Pallet">Pallet</option>
            <option value="Count">Count</option>
        </select>
        <select id="category" required>
            <option value="Dry">Dry</option>
            <option value="Refrigerated">Refrigerated</option>
            <option value="Frozen">Frozen</option>
            <option value="Produce">Produce</option>
        </select>
        <input type="date" id="expiration" placeholder="Expiration Date (optional)">
        <button onclick="addItem()"><i class="fas fa-plus"></i> Add Item</button>
        <p class="fifo-note">Tip: Use FIFO (First In, First Out) for perishables to minimize waste.</p>
    </div>
    <div class="form-container">
        <h2>Record Out</h2>
        <input type="text" id="outItemName" placeholder="Item Name" list="itemSuggestions" required>
        <input type="number" id="outQuantity" placeholder="Quantity Out" required min="1">
        <select id="outUnit">
            <option value="">No Unit</option>
            <option value="Pounds">Pounds</option>
            <option value="Case">Case</option>
            <option value="Pallet">Pallet</option>
            <option value="Count">Count</option>
        </select>
        <button class="out-btn" onclick="recordItemOut()"><i class="fas fa-minus"></i> Record Out</button>
    </div>
    <div class="filter-container">
        <label>Search by Item Name:</label>
        <input type="text" id="searchInput" placeholder="Search items...">
        <label>Filter by Category:</label>
        <select id="categoryFilter" onchange="renderTable()">
            <option value="All">All</option>
            <option value="Dry">Dry</option>
            <option value="Refrigerated">Refrigerated</option>
            <option value="Frozen">Frozen</option>
            <option value="Produce">Produce</option>
        </select>
        <button class="export-btn" onclick="exportReport()"><i class="fas fa-download"></i> Export Report</button>
    </div>
    <div class="chart-container">
        <canvas id="categoryChart"></canvas>
    </div>
    <table id="inventoryTable">
        <thead>
            <tr>
                <th onclick="sortTable('name')">Item Name</th>
                <th onclick="sortTable('quantity')">Quantity</th>
                <th onclick="sortTable('unit')">Unit</th>
                <th onclick="sortTable('category')">Category</th>
                <th onclick="sortTable('expiration')">Expiration</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="inventoryBody"></tbody>
    </table>
    <div class="history-container">
        <h2>Transaction History</h2>
        <button class="clear-btn" onclick="clearHistory()"><i class="fas fa-trash"></i> Clear History</button>
        <table id="historyTable">
            <thead>
                <tr>
                    <th>Item Name</th>
                    <th>Action</th>
                    <th>Quantity</th>
                    <th>Unit</th>
                    <th>Category</th>
                    <th>Date</th>
                </tr>
            </thead>
            <tbody id="historyBody"></tbody>
        </table>
    </div>
    <div id="scanner-container">
        <div id="scanner-loading">Initializing Scanner...</div>
        <div style="position: relative; width: 90%; max-width: 640px;">
            <video id="scanner-video"></video>
            <canvas id="scanner-overlay"></canvas>
        </div>
        <div id="scanner-controls">
            <button onclick="stopScanner()">Cancel</button>
        </div>
    </div>

    <script>
        let inventory = JSON.parse(localStorage.getItem('inventory')) || [];
        let history = JSON.parse(localStorage.getItem('history')) || [];
        let barcodeMap = JSON.parse(localStorage.getItem('barcodeMap')) || {};
        let sortKey = 'name';
        let sortAsc = true;
        const LOW_STOCK_THRESHOLD = 10;
        const ALMOST_LOW_THRESHOLD = 20;
        const EXPIRATION_WARNING_DAYS = 7;
        let chart = null;
        let lastDetectedCode = null;
        let lastDetectedTime = 0;

        function saveData() {
            localStorage.setItem('inventory', JSON.stringify(inventory));
            localStorage.setItem('history', JSON.stringify(history));
            localStorage.setItem('barcodeMap', JSON.stringify(barcodeMap));
            renderTable();
        }

        function updateSuggestions() {
            const datalist = document.getElementById('itemSuggestions');
            datalist.innerHTML = '';
            const uniqueNames = [...new Set(inventory.map(item => item.name))];
            uniqueNames.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                datalist.appendChild(option);
            });
        }

        function addItem() {
            const name = document.getElementById('itemName').value.trim();
            const quantity = parseInt(document.getElementById('quantity').value);
            const unit = document.getElementById('unit').value || 'No Unit';
            const category = document.getElementById('category').value;
            const expiration = document.getElementById('expiration').value || '';
            if (!name) {
                alert('Item name is required!');
                return;
            }
            if (isNaN(quantity) || quantity < 0) {
                alert('Quantity must be a non-negative number!');
                return;
            }
            if (!category) {
                alert('Category is required!');
                return;
            }
            if (expiration && new Date(expiration) < new Date()) {
                if (!confirm('Expiration date is in the past. Add anyway?')) return;
            }
            const existingItem = inventory.find(item => item.name.toLowerCase() === name.toLowerCase() && item.unit === unit && item.category === category);
            if (existingItem) {
                if (confirm(`Item "${name}" with unit "${unit}" in "${category}" already exists. Update quantity?`)) {
                    existingItem.quantity += quantity;
                    if (expiration) existingItem.expiration = expiration;
                    alert(`Updated ${name}: Added ${quantity} ${unit} to existing stock.`);
                } else {
                    return;
                }
            } else {
                inventory.push({ name, quantity, unit, category, expiration });
                alert(`Added ${name}: ${quantity} ${unit} to inventory.`);
            }
            history.push({ name, action: 'Added', quantity, unit, category, date: new Date().toLocaleString() });
            saveData();
            document.getElementById('itemName').value = '';
            document.getElementById('quantity').value = '';
            document.getElementById('unit').value = '';
            document.getElementById('category').value = 'Dry';
            document.getElementById('expiration').value = '';
            updateSuggestions();
        }

        function recordItemOut() {
            const name = document.getElementById('outItemName').value.trim();
            const quantity = parseInt(document.getElementById('outQuantity').value);
            const unit = document.getElementById('outUnit').value || 'No Unit';
            if (!name) {
                alert('Item name is required!');
                return;
            }
            if (isNaN(quantity) || quantity <= 0) {
                alert('Quantity must be a positive number!');
                return;
            }
            const item = inventory.find(item => item.name.toLowerCase() === name.toLowerCase() && item.unit === unit);
            if (!item) {
                alert(`Item "${name}" with unit "${unit}" not found!`);
                return;
            }
            if (quantity > item.quantity) {
                alert(`Cannot remove ${quantity} ${unit} of ${name}. Only ${item.quantity} available!`);
                return;
            }
            item.quantity -= quantity;
            history.push({ name, action: 'Removed', quantity, unit, category: item.category, date: new Date().toLocaleString() });
            alert(`Removed ${quantity} ${unit} of ${name} from inventory.`);
            if (item.quantity === 0) {
                inventory = inventory.filter(i => i !== item);
            }
            saveData();
            document.getElementById('outItemName').value = '';
            document.getElementById('outQuantity').value = '';
            document.getElementById('outUnit').value = '';
            updateSuggestions();
        }

        function deleteItem(index) {
            const item = inventory[index];
            history.push({ name: item.name, action: 'Deleted', quantity: item.quantity, unit: item.unit, category: item.category, date: new Date().toLocaleString() });
            inventory.splice(index, 1);
            saveData();
            alert(`Deleted ${item.name} from inventory.`);
            updateSuggestions();
        }

        function updateItem(index) {
            const item = inventory[index];
            const name = prompt('Enter new item name:', item.name)?.trim();
            const quantity = parseInt(prompt('Enter new quantity:', item.quantity));
            const unit = prompt('Enter new unit (Pounds, Case, Pallet, Count, or leave blank):', item.unit === 'No Unit' ? '' : item.unit) || 'No Unit';
            const category = prompt('Enter new category (Dry, Refrigerated, Frozen, Produce):', item.category);
            const expiration = prompt('Enter new expiration date (YYYY-MM-DD, optional):', item.expiration) || '';
            if (!name) {
                alert('Item name is required!');
                return;
            }
            if (isNaN(quantity) || quantity < 0) {
                alert('Quantity must be a non-negative number!');
                return;
            }
            if (!['Dry', 'Refrigerated', 'Frozen', 'Produce'].includes(category)) {
                alert('Invalid category! Choose Dry, Refrigerated, Frozen, or Produce.');
                return;
            }
            if (!['Pounds', 'Case', 'Pallet', 'Count', 'No Unit'].includes(unit)) {
                alert('Invalid unit! Choose Pounds, Case, Pallet, Count, or leave blank.');
                return;
            }
            if (expiration && new Date(expiration) < new Date()) {
                if (!confirm('Expiration date is in the past. Update anyway?')) return;
            }
            history.push({ name: item.name, action: 'Updated', quantity: quantity - item.quantity, unit: item.unit, category: item.category, date: new Date().toLocaleString() });
            inventory[index] = { name, quantity, unit, category, expiration };
            saveData();
            alert(`Updated ${name} to ${quantity} ${unit} in ${category}.`);
            updateSuggestions();
        }

        function clearHistory() {
            if (history.length === 0) {
                alert('Transaction history is already empty!');
                return;
            }
            if (confirm('Are you sure you want to clear the transaction history?')) {
                history = [];
                saveData();
                alert('Transaction history cleared.');
            }
        }

        function sortTable(key) {
            if (sortKey === key) sortAsc = !sortAsc;
            else sortKey = key;
            inventory.sort((a, b) => {
                let valA = a[key], valB = b[key];
                if (key === 'name' || key === 'category' || key === 'unit') {
                    valA = valA.toLowerCase();
                    valB = valB.toLowerCase();
                } else if (key === 'expiration') {
                    valA = a.expiration ? new Date(a.expiration) : new Date(0);
                    valB = b.expiration ? new Date(b.expiration) : new Date(0);
                } else if (key === 'quantity') {
                    valA = a.quantity;
                    valB = b.quantity;
                }
                return sortAsc ? (valA > valB ? 1 : -1) : (valA < valB ? 1 : -1);
            });
            renderTable();
        }

        function checkAlerts() {
            const today = new Date();
            const warningDate = new Date();
            warningDate.setDate(today.getDate() + EXPIRATION_WARNING_DAYS);

            const lowStockItems = inventory.filter(item => item.quantity <= LOW_STOCK_THRESHOLD && item.quantity > 0);
            const expiredItems = inventory.filter(item => item.expiration && new Date(item.expiration) < today);
            const nearExpiredItems = inventory.filter(item => item.expiration && new Date(item.expiration) >= today && new Date(item.expiration) <= warningDate);

            const smartAlert = document.getElementById('smartAlert');
            const smartMessage = document.getElementById('smartMessage');
            const alerts = [];
            if (lowStockItems.length > 0) {
                alerts.push(`Low stock: ${lowStockItems.map(item => `${item.name} (${item.quantity} ${item.unit})`).join(', ')}. Restock soon.`);
            }
            if (expiredItems.length > 0) {
                alerts.push(`Expired: ${expiredItems.map(item => `${item.name} (${item.expiration})`).join(', ')}. Remove or donate immediately.`);
            }
            if (nearExpiredItems.length > 0) {
                alerts.push(`Expiring soon: ${nearExpiredItems.map(item => `${item.name} (${item.expiration})`).join(', ')}. Consider donating.`);
            }
            if (alerts.length > 0) {
                smartMessage.innerHTML = alerts.join('<br>');
                smartAlert.classList.add('show');
            } else {
                smartAlert.classList.remove('show');
            }
        }

        function updateOverview() {
            const totalItems = inventory.length;
            const inStock = inventory.filter(item => item.quantity > 0).length;
            const outOfStock = inventory.filter(item => item.quantity === 0).length;
            const lowStock = inventory.filter(item => item.quantity <= LOW_STOCK_THRESHOLD && item.quantity > 0).length;
            document.getElementById('totalItems').textContent = totalItems;
            document.getElementById('inStock').textContent = inStock;
            document.getElementById('outOfStock').textContent = outOfStock;
            document.getElementById('lowStock').textContent = lowStock;
        }

        function updateChart() {
            const ctx = document.getElementById('categoryChart').getContext('2d');
            const categoryCounts = inventory.reduce((acc, item) => {
                acc[item.category] = (acc[item.category] || 0) + item.quantity;
                return acc;
            }, {});
            const data = {
                labels: ['Dry', 'Refrigerated', 'Frozen', 'Produce'],
                datasets: [{
                    data: [
                        categoryCounts['Dry'] || 0,
                        categoryCounts['Refrigerated'] || 0,
                        categoryCounts['Frozen'] || 0,
                        categoryCounts['Produce'] || 0
                    ],
                    backgroundColor: ['#2a5c3a', '#5c4b2a', '#0055a4', '#5c2a2a']
                }]
            };
            if (chart) chart.destroy();
            chart = new Chart(ctx, {
                type: 'pie',
                data: data,
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom', labels: { color: 'white' } },
                        title: { display: true, text: 'Inventory by Category', color: 'white' }
                    }
                }
            });
        }

        function exportReport() {
            if (inventory.length === 0) {
                alert('Inventory is empty! Add items before exporting.');
                return;
            }
            const now = new Date();
            const dateStr = now.toISOString().slice(0, 10).replace(/-/g, '');
            const timeStr = now.toTimeString().slice(0, 5).replace(/:/g, '');
            const timestamp = `${dateStr}_${timeStr}`;
            const csv = [
                `Inventory Report,Generated: ${now.toLocaleString()}`,
                'Item Name,Quantity,Unit,Category,Expiration',
                ...inventory.map(item => `${item.name},${item.quantity},${item.unit},${item.category},${item.expiration || 'N/A'}`)
            ].join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `inventory_${timestamp}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            alert('Inventory report exported as CSV.');
        }

        function renderTable() {
            const tbody = document.getElementById('inventoryBody');
            const filter = document.getElementById('categoryFilter').value;
            const search = document.getElementById('searchInput').value.toLowerCase();
            tbody.innerHTML = '';
            inventory
                .filter(item => (filter === 'All' || item.category === filter) && item.name.toLowerCase().includes(search))
                .forEach((item, index) => {
                    const row = document.createElement('tr');
                    const today = new Date();
                    const expirationDate = item.expiration ? new Date(item.expiration) : null;
                    const warningDate = new Date();
                    warningDate.setDate(today.getDate() + EXPIRATION_WARNING_DAYS);

                    if (expirationDate && expirationDate < today) {
                        row.classList.add('expired');
                    } else if (expirationDate && expirationDate <= warningDate) {
                        row.classList.add('near-expired');
                    } else if (item.quantity === 0) {
                        row.classList.add('out-of-stock');
                    } else if (item.quantity <= LOW_STOCK_THRESHOLD) {
                        row.classList.add('low-stock');
                    } else if (item.quantity <= ALMOST_LOW_THRESHOLD) {
                        row.classList.add('almost-low');
                    } else {
                        row.classList.add('good-stock');
                    }
                    row.style.opacity = '0';
                    row.innerHTML = `
                        <td data-label="Item Name">${item.name}</td>
                        <td data-label="Quantity">${item.quantity}</td>
                        <td data-label="Unit">${item.unit}</td>
                        <td data-label="Category">${item.category}</td>
                        <td data-label="Expiration">${item.expiration || 'N/A'}</td>
                        <td data-label="Actions">
                            <button onclick="updateItem(${index})"><i class="fas fa-edit"></i> Update</button>
                            <button class="delete-btn" onclick="deleteItem(${index})"><i class="fas fa-trash"></i> Delete</button>
                        </td>
                        <div class="swipe-action swipe-delete">Delete</div>
                        <div class="swipe-action swipe-update">Update</div>
                    `;
                    tbody.appendChild(row);
                    setTimeout(() => { row.style.opacity = '1'; }, 10);
                    addSwipeGestures(row, index);
                });
            renderHistory();
            checkAlerts();
            updateOverview();
            updateChart();
            updateSuggestions();
        }

        function renderHistory() {
            const historyBody = document.getElementById('historyBody');
            historyBody.innerHTML = '';
            history.slice().reverse().slice(0, 50).forEach(record => {
                const row = document.createElement('tr');
                row.style.opacity = '0';
                row.innerHTML = `
                    <td data-label="Item Name">${record.name}</td>
                    <td data-label="Action">${record.action}</td>
                    <td data-label="Quantity">${record.quantity}</td>
                    <td data-label="Unit">${record.unit}</td>
                    <td data-label="Category">${record.category}</td>
                    <td data-label="Date">${record.date}</td>
                `;
                historyBody.appendChild(row);
                setTimeout(() => { row.style.opacity = '1'; }, 10);
            });
        }

        function addSwipeGestures(row, index) {
            let startX = 0;
            let currentX = 0;
            let isSwiping = false;

            row.addEventListener('touchstart', e => {
                startX = e.touches[0].clientX;
                isSwiping = true;
                row.style.transition = 'none';
            });

            row.addEventListener('touchmove', e => {
                if (!isSwiping) return;
                currentX = e.touches[0].clientX - startX;
                if (currentX > 80) currentX = 80;
                if (currentX < -80) currentX = -80;
                row.style.transform = `translateX(${currentX}px)`;
            });

            row.addEventListener('touchend', () => {
                isSwiping = false;
                row.style.transition = 'transform 0.3s ease';
                if (currentX > 60) {
                    updateItem(index);
                    row.style.transform = 'translateX(0)';
                } else if (currentX < -60) {
                    if (confirm(`Delete ${inventory[index].name}?`)) {
                        deleteItem(index);
                    }
                    row.style.transform = 'translateX(0)';
                } else {
                    row.style.transform = 'translateX(0)';
                }
                currentX = 0;
            });
        }

        let scanning = false;
        function startScanner() {
            const scannerContainer = document.getElementById('scanner-container');
            const scannerVideo = document.getElementById('scanner-video');
            const scannerOverlay = document.getElementById('scanner-overlay');
            const scannerLoading = document.getElementById('scanner-loading');

            scannerLoading.style.display = 'block';
            scannerContainer.style.display = 'flex';

            navigator.mediaDevices.getUserMedia({ 
                video: { 
                    facingMode: "environment",
                    width: { ideal: 640 },
                    height: { ideal: 480 }
                } 
            })
                .then(stream => {
                    scannerVideo.srcObject = stream;
                    scannerVideo.play().then(() => {
                        scannerLoading.style.display = 'none';
                        Quagga.init({
                            inputStream: {
                                name: "Live",
                                type: "LiveStream",
                                target: scannerVideo,
                                constraints: {
                                    facingMode: "environment",
                                    width: { ideal: 640 },
                                    height: { ideal: 480 }
                                }
                            },
                            locator: {
                                patchSize: "medium",
                                halfSample: true
                            },
                            numOfWorkers: navigator.hardwareConcurrency || 4,
                            decoder: {
                                readers: [
                                    "code_128_reader",
                                    "ean_reader",
                                    "ean_8_reader",
                                    "code_39_reader",
                                    "codabar_reader",
                                    "upc_reader",
                                    "upc_e_reader",
                                    "i2of5_reader"
                                ]
                            },
                            locate: true
                        }, err => {
                            if (err) {
                                alert('Error initializing scanner: ' + err.message);
                                stopScanner();
                                return;
                            }
                            Quagga.start();
                            scanning = true;
                        });

                        Quagga.onProcessed(result => {
                            if (result && result.box) {
                                drawBoundingBox(result.box);
                            } else {
                                scannerOverlay.style.display = 'none';
                            }
                        });

                        Quagga.onDetected(result => {
                            if (scanning) {
                                const code = result.codeResult.code;
                                const currentTime = Date.now();
                                if (code === lastDetectedCode && currentTime - lastDetectedTime < 1000) {
                                    return;
                                }
                                lastDetectedCode = code;
                                lastDetectedTime = currentTime;

                                navigator.vibrate?.(100);
                                const itemName = barcodeMap[code] || code;
                                document.getElementById('itemName').value = itemName;
                                if (!barcodeMap[code]) {
                                    const customName = prompt(`Enter name for barcode ${code}:`, itemName) || itemName;
                                    barcodeMap[code] = customName;
                                    document.getElementById('itemName').value = customName;
                                }
                                alert(`Barcode detected: ${code} (${document.getElementById('itemName').value})`);
                                scanning = false;
                                Quagga.stop();
                                stopScanner();
                                saveData();
                            }
                        });
                    }).catch(err => {
                        alert('Error playing video: ' + err.message);
                        stopScanner();
                    });
                })
                .catch(err => {
                    alert('Camera access denied or unavailable: ' + err.message);
                    scannerLoading.style.display = 'none';
                    scannerContainer.style.display = 'none';
                });
        }

        function drawBoundingBox(box) {
            const canvas = document.getElementById('scanner-overlay');
            const video = document.getElementById('scanner-video');
            canvas.width = video.offsetWidth;
            canvas.height = video.offsetHeight;
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = 'rgba(0, 255, 0, 0.7)';
            ctx.lineWidth = 4;
            ctx.beginPath();
            ctx.moveTo(box[0][0], box[0][1]);
            ctx.lineTo(box[1][0], box[1][1]);
            ctx.lineTo(box[2][0], box[2][1]);
            ctx.lineTo(box[3][0], box[3][1]);
            ctx.closePath();
            ctx.stroke();
            canvas.style.display = 'block';
            canvas.style.top = `${video.offsetTop}px`;
            canvas.style.left = `${video.offsetLeft}px`;
            canvas.style.position = 'absolute';
        }

        function stopScanner() {
            if (scanning) {
                Quagga.stop();
                scanning = false;
            }
            const scannerVideo = document.getElementById('scanner-video');
            if (scannerVideo.srcObject) {
                scannerVideo.srcObject.getTracks().forEach(track => track.stop());
                scannerVideo.srcObject = null;
            }
            document.getElementById('scanner-container').style.display = 'none';
            document.getElementById('scanner-overlay').style.display = 'none';
            document.getElementById('scanner-loading').style.display = 'none';
        }

        document.getElementById('searchInput').addEventListener('input', renderTable);

        window.onload = () => {
            renderTable();
            updateSuggestions();
        };

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js').catch(err => console.log('Service Worker Error:', err));
        }
    </script>
</body>
</html>